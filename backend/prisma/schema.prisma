generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-1.1.x", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  SUPERVISOR
  AGENT
}

enum InterventionType {
  REGULAR
  PUNCTUAL
}

enum InterventionStatus {
  PLANNED
  IN_PROGRESS
  COMPLETED
  NEEDS_REVIEW
  CANCELLED
  NO_SHOW
}

enum AttendanceStatus {
  PENDING
  COMPLETED
  CANCELLED
}

enum AbsenceStatus {
  PENDING
  APPROVED
  REJECTED
}

enum AbsenceType {
  SICK
  PAID_LEAVE
  UNPAID
  OTHER
}

enum AnomalyStatus {
  NEW
  RESOLVED
}

enum NotificationAudience {
  ALL_AGENTS
  SITE_AGENTS
  AGENT
}

enum AuditAction {
  CREATE_NOTIFICATION
  CREATE_ABSENCE
  UPDATE_ABSENCE_STATUS
  CREATE_MANUAL_ATTENDANCE
  UPDATE_ATTENDANCE
  CANCEL_ATTENDANCE
  UPDATE_SETTINGS
}

model User {
  id            String                   @id @default(cuid())
  firstName     String
  lastName      String
  email         String                   @unique
  phone         String?
  role          Role
  password      String
  active        Boolean                  @default(true)
  createdAt     DateTime                 @default(now())
  updatedAt     DateTime                 @updatedAt
  supervising   SiteSupervisor[]
  interventions InterventionAssignment[]
  attendance    Attendance[]
  absences      Absence[]
  pushTokens    PushToken[]
  anomalies     Anomaly[]
}

model Client {
  id           String   @id @default(cuid())
  name         String
  contactName  String?
  contactEmail String?
  contactPhone String?
  active       Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  sites        Site[]
}

model Site {
  id               String             @id @default(cuid())
  name             String
  address          String
  latitude         Float?
  longitude        Float?
  timeWindow       String?
  active           Boolean            @default(true)
  clientId         String
  client           Client             @relation(fields: [clientId], references: [id])
  supervisors      SiteSupervisor[]
  interventions    Intervention[]
  attendance       Attendance[]
  absences         Absence[]
  InterventionRule InterventionRule[]
}

model SiteSupervisor {
  siteId String
  userId String
  site   Site   @relation(fields: [siteId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([siteId, userId])
}

model Intervention {
  id                  String                   @id @default(cuid())
  siteId              String
  site                Site                     @relation(fields: [siteId], references: [id])
  date                DateTime
  startTime           String
  endTime             String
  type                InterventionType
  subType             String?
  label               String?
  photos              String[]               @default([])
  status              InterventionStatus       @default(PLANNED)
  observation         String?
  createdAt           DateTime                 @default(now())
  updatedAt           DateTime                 @updatedAt
  assignments         InterventionAssignment[]
  trucks              InterventionTruck[]
  anomalies           Anomaly[]
  generatedFromRuleId String?
  generatedFromRule   InterventionRule?        @relation(fields: [generatedFromRuleId], references: [id])
  attendances         Attendance[]
}

model InterventionAssignment {
  interventionId String
  userId         String
  intervention   Intervention @relation(fields: [interventionId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([interventionId, userId])
}

model InterventionTruck {
  id             String       @id @default(cuid())
  label          String
  interventionId String
  intervention   Intervention @relation(fields: [interventionId], references: [id], onDelete: Cascade)
}

model InterventionRule {
  id            String         @id @default(cuid())
  siteId        String
  site          Site           @relation(fields: [siteId], references: [id])
  label         String
  startTime     String
  endTime       String
  daysOfWeek    Int[]
  agentIds      String[]
  active        Boolean        @default(true)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  interventions Intervention[]
}

model Attendance {
  id                String           @id @default(cuid())
  userId            String
  siteId            String
  clientId          String
  interventionId    String?
  date              DateTime
  arrivalTime       DateTime?
  arrivalLatitude   Float?
  arrivalLongitude  Float?
  lastSeenAt        DateTime?
  lastSeenLatitude  Float?
  lastSeenLongitude Float?
  outsideSince      DateTime?
  checkInTime       DateTime?
  checkOutTime      DateTime?
  checkInLatitude   Float?
  checkInLongitude  Float?
  checkOutLatitude  Float?
  checkOutLongitude Float?
  plannedStart      DateTime?
  plannedEnd        DateTime?
  status            AttendanceStatus @default(PENDING)
  manual            Boolean          @default(false)
  createdBy         String
  note              String?
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  user              User             @relation(fields: [userId], references: [id])
  site              Site             @relation(fields: [siteId], references: [id])
  intervention      Intervention?    @relation(fields: [interventionId], references: [id], onDelete: SetNull)
}

model Absence {
  id                String        @id @default(cuid())
  userId            String
  siteId            String?
  type              AbsenceType
  status            AbsenceStatus @default(PENDING)
  from              DateTime
  to                DateTime
  reason            String
  note              String?
  validatedBy       String?
  validationComment String?
  manual            Boolean       @default(false)
  createdBy         String
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  user              User          @relation(fields: [userId], references: [id])
  site              Site?         @relation(fields: [siteId], references: [id])
}

model Notification {
  id         String               @id @default(cuid())
  title      String
  message    String
  audience   NotificationAudience
  targetId   String?
  targetName String?
  createdAt  DateTime             @default(now())
}

model Anomaly {
  id              String         @id @default(cuid())
  interventionId  String
  intervention    Intervention   @relation(fields: [interventionId], references: [id], onDelete: Cascade)
  userId          String
  user            User           @relation(fields: [userId], references: [id])
  type            String
  title           String?
  description     String
  photos          String[]
  status          AnomalyStatus  @default(NEW)
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
}

model PushToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
}

model Setting {
  key       String   @id
  value     Json
  updatedAt DateTime @updatedAt
}

model AuditLog {
  id         String      @id @default(cuid())
  actorId    String
  action     AuditAction
  entityType String
  entityId   String?
  details    String?
  createdAt  DateTime    @default(now())
}
